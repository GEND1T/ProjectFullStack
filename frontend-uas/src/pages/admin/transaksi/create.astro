---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
const API_URL = import.meta.env.PUBLIC_API_URL;
const SERVER_URL = "http://localhost:3000";

// Fetch Data Master (Produk, Customer, Kategori, DAN USER/KASIR)
let products = [];
let customers = [];
let categories = [];
let users = []; // Variabel untuk menyimpan data kasir

try {
    const [resProd, resCust, resCat, resUser] = await Promise.all([
        fetch(`${API_URL}/products`),
        fetch(`${API_URL}/customers`),
        fetch(`${API_URL}/products/categories`),
        fetch(`${API_URL}/users`) // Fetch data kasir
    ]);
    
    const jsonProd = await resProd.json();
    products = jsonProd.data || [];
    customers = await resCust.json();
    categories = await resCat.json();
    users = await resUser.json(); // Simpan data kasir
} catch (e) { 
    console.error("Gagal load data POS", e); 
}
---

<DashboardLayout title="Kasir / POS" currentPath="penjualan">
    
    <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-140px)]">
        
        <div class="lg:w-2/3 flex flex-col bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 border-b border-gray-100 flex gap-3">
                <input type="text" id="searchProduct" placeholder="Cari nama produk..." class="flex-1 px-4 py-2 border rounded-lg bg-gray-50 focus:bg-white transition outline-none focus:ring-2 focus:ring-blue-100">
                <select id="filterCategory" class="px-4 py-2 border rounded-lg bg-gray-50">
                    <option value="all">Semua Kategori</option>
                    {categories.map((c: any) => <option value={c.name}>{c.name}</option>)}
                </select>
            </div>

            <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="productGrid">
                    {products.map((p: any) => (
                        <div class="product-card bg-white p-3 rounded-lg shadow-sm border hover:shadow-md cursor-pointer transition active:scale-95 flex flex-col h-full"
                             onclick={`addToCart('${p.id}')`} 
                             data-name={p.name.toLowerCase()}
                             data-category={p.category_name}
                        >
                            <div class="h-32 bg-gray-100 rounded-md mb-3 overflow-hidden">
                                {p.image ? (
                                    <img src={`${SERVER_URL}${p.image}`} class="w-full h-full object-cover" loading="lazy">
                                ) : (
                                    <div class="w-full h-full flex items-center justify-center text-gray-300">No Img</div>
                                )}
                            </div>
                            <h4 class="font-bold text-gray-800 text-sm line-clamp-2 leading-tight mb-1">{p.name}</h4>
                            <div class="mt-auto pt-2 flex justify-between items-center">
                                <span class="text-blue-600 font-bold text-sm">Rp {parseInt(p.price).toLocaleString('id-ID')}</span>
                                <span class="text-[10px] text-gray-400">Stok: {p.stock}</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>

        <div class="lg:w-1/3 flex flex-col bg-white rounded-xl shadow-lg border border-blue-100 h-full">
            <div class="p-5 border-b border-gray-100 bg-gray-50 rounded-t-xl">
                <h2 class="font-bold text-gray-800 flex items-center gap-2">
                    üõí Keranjang Belanja
                </h2>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-3" id="cartContainer">
                <div id="emptyCartMsg" class="h-full flex flex-col items-center justify-center text-gray-400">
                    <span class="text-4xl mb-2">üõçÔ∏è</span>
                    <p class="text-sm">Belum ada item dipilih</p>
                </div>
            </div>

            <div class="p-5 border-t border-gray-100 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Kasir Bertugas</label>
                    <select id="cashierSelect" class="w-full mt-1 p-2 border rounded-lg text-sm bg-blue-50 border-blue-200 text-blue-800 font-medium">
                        <option value="">-- Pilih Kasir --</option>
                        {users.map((u: any) => <option value={u.id}>{u.name}</option>)}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Pelanggan</label>
                    <select id="customerSelect" class="w-full mt-1 p-2 border rounded-lg text-sm bg-gray-50">
                        <option value="">-- Tamu / Guest --</option>
                        {customers.map((c: any) => <option value={c.id}>{c.name} ({c.phone})</option>)}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Pembayaran</label>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                        <button type="button" onclick="setPayment(1, this)" class="pay-btn active bg-blue-100 border-blue-500 border text-blue-700 p-2 rounded text-center text-xs font-bold">Tunai</button>
                        <button type="button" onclick="setPayment(2, this)" class="pay-btn bg-white border-gray-200 border text-gray-600 p-2 rounded text-center text-xs hover:bg-gray-50">QRIS</button>
                        <button type="button" onclick="setPayment(3, this)" class="pay-btn bg-white border-gray-200 border text-gray-600 p-2 rounded text-center text-xs hover:bg-gray-50">Transfer</button>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-500 font-medium">Total Bayar</span>
                    <span class="text-2xl font-bold text-gray-800" id="totalDisplay">Rp 0</span>
                </div>

                <button id="btnCheckout" onclick="processCheckout()" disabled class="w-full bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white py-3 rounded-xl font-bold text-lg hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">
                    Bayar Sekarang
                </button>
            </div>
        </div>
    </div>
</DashboardLayout>

<script define:vars={{ API_URL, products }}> 
    
    // --- STATE MANAGER ---
    let cart = [];
    let selectedPaymentId = 1;
    // const currentUserId = 'ADM001'; // HAPUS INI, kita ambil dari dropdown

    // --- HELPER FORMAT ---
    const formatRupiah = (num) => {
        return "Rp " + Number(num).toLocaleString('id-ID');
    };

    // --- FUNGSI CART ---
    window.addToCart = (productId) => {
        const product = products.find(p => p.id == productId);

        if (!product) {
            console.error("Produk tidak ditemukan!");
            return;
        }

        const priceNum = parseInt(product.price); 
        const stockNum = parseInt(product.stock);

        const existing = cart.find(item => item.product_id == productId);
        const currentQty = existing ? existing.qty : 0;

        if (currentQty + 1 > stockNum) {
            alert("Stok tidak mencukupi!");
            return;
        }

        if (existing) {
            existing.qty++;
            existing.subtotal = existing.qty * priceNum;
        } else {
            cart.push({
                product_id: product.id,
                name: product.name,
                price: priceNum,
                qty: 1,
                subtotal: priceNum
            });
        }
        renderCart();
    };

    window.removeFromCart = (index) => {
        cart.splice(index, 1);
        renderCart();
    };

    window.updateQty = (index, delta) => {
        const item = cart[index];
        const product = products.find(p => p.id == item.product_id);

        if (!product) return;
        const maxStock = parseInt(product.stock);
        const newQty = item.qty + delta;

        if (newQty > maxStock) {
            alert("Mencapai batas stok!");
            return;
        }

        if (newQty > 0) {
            item.qty = newQty;
            item.subtotal = item.qty * item.price;
            renderCart();
        } else {
            removeFromCart(index);
        }
    };

    function renderCart() {
        const container = document.getElementById('cartContainer');
        const totalDisplay = document.getElementById('totalDisplay');
        const btnCheckout = document.getElementById('btnCheckout');

        container.innerHTML = ''; 
        
        let total = 0;

        if (cart.length === 0) {
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-gray-400">
                    <span class="text-4xl mb-2">üõçÔ∏è</span>
                    <p class="text-sm">Belum ada item dipilih</p>
                </div>
            `;
            btnCheckout.disabled = true;
            totalDisplay.innerText = "Rp 0";
        } else {
            btnCheckout.disabled = false;

            cart.forEach((item, index) => {
                total += Number(item.subtotal); 
                
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100';
                el.innerHTML = `
                    <div class="flex-1">
                        <p class="font-bold text-sm text-gray-800 line-clamp-1">${item.name}</p>
                        <p class="text-xs text-blue-600">${formatRupiah(item.price)} x ${item.qty}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="updateQty(${index}, -1)" class="w-6 h-6 rounded-l bg-white border text-gray-600 hover:bg-gray-200 flex items-center justify-center font-bold">-</button>
                        <span class="text-sm font-bold w-6 text-center border-t border-b bg-white h-6 flex items-center justify-center">${item.qty}</span>
                        <button onclick="updateQty(${index}, 1)" class="w-6 h-6 rounded-r bg-white border text-gray-600 hover:bg-gray-200 flex items-center justify-center font-bold">+</button>
                    </div>
                `;
                container.appendChild(el);
            });
        }
        totalDisplay.innerText = formatRupiah(total);
    }

    // --- PAYMENT & FILTER ---
    window.setPayment = (id, btn) => {
        selectedPaymentId = id;
        document.querySelectorAll('.pay-btn').forEach(b => {
            b.classList.remove('active', 'bg-blue-100', 'border-blue-500', 'text-blue-700');
            b.classList.add('bg-white', 'border-gray-200', 'text-gray-600');
        });
        btn.classList.remove('bg-white', 'border-gray-200', 'text-gray-600');
        btn.classList.add('active', 'bg-blue-100', 'border-blue-500', 'text-blue-700');
    }

    const searchInput = document.getElementById('searchProduct');
    const filterSelect = document.getElementById('filterCategory');

    function filterProducts() {
        const term = searchInput.value.toLowerCase();
        const cat = filterSelect.value;
        
        document.querySelectorAll('.product-card').forEach(card => {
            const name = (card.dataset.name || '').toLowerCase();
            const category = card.dataset.category || '';
            const matchSearch = name.includes(term);
            const matchCat = cat === 'all' || category === cat;

            if (matchSearch && matchCat) card.style.display = 'flex';
            else card.style.display = 'none';
        });
    }

    searchInput.addEventListener('input', filterProducts);
    filterSelect.addEventListener('change', filterProducts);

    // --- CHECKOUT ---
    window.processCheckout = async () => {
        if (cart.length === 0) return;

        // 1. Ambil ID Kasir dari Dropdown
        const cashierId = document.getElementById('cashierSelect').value;
        if (!cashierId) {
            alert("‚ö†Ô∏è Harap pilih Kasir yang bertugas terlebih dahulu!");
            return;
        }

        if (!confirm("Proses transaksi ini?")) return;

        const custId = document.getElementById('customerSelect').value;
        const totalAmount = cart.reduce((sum, item) => sum + item.subtotal, 0);
        const btn = document.getElementById('btnCheckout');

        const payload = {
            user_id: cashierId, // Gunakan ID Kasir yang dipilih
            cust_id: custId,        
            method_id: selectedPaymentId,
            total_amount: totalAmount,
            items: cart.map(item => ({
                product_id: item.product_id,
                price: item.price,
                qty: item.qty,
                subtotal: item.subtotal
            }))
        };

        try {
            btn.innerText = "Memproses...";
            btn.disabled = true;

            const res = await fetch(`${API_URL}/transaksi/checkout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await res.json();

            if (res.ok) {
                alert(`‚úÖ Transaksi Berhasil! Invoice: ${result.invoice}`);
                cart = [];
                renderCart();
            } else {
                alert("‚ùå Gagal: " + result.message);
                btn.innerText = "Bayar Sekarang";
                btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            alert("Error koneksi server");
            btn.innerText = "Bayar Sekarang";
            btn.disabled = false;
        }
    }
</script>