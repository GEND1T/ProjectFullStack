---
import DashboardLayout from '../../../../layouts/DashboardLayout.astro';
const { id } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL;

let category = null;
let errorMsg = null;

try {
    const res = await fetch(`${API_URL}/categories/${id}`);
    if (res.ok) {
        category = await res.json();
    } else {
        errorMsg = "Kategori tidak ditemukan.";
    }
} catch (e) {
    errorMsg = "Error koneksi server.";
}
---

<DashboardLayout title="Edit Kategori" currentPath="products">
    <div class="max-w-md mx-auto mt-10">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Edit Kategori</h1>
            <a href="/admin/categories" class="text-gray-500 hover:text-blue-600 text-sm">&larr; Kembali</a>
        </div>

        {errorMsg && <div class="bg-red-100 text-red-700 p-4 rounded mb-4">{errorMsg}</div>}

        {category && (
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <form id="editCategoryForm" class="space-y-4">
                    
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-500">Kode Kategori (ID)</label>
                        <input type="text" value={category.id} disabled class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-100 text-gray-500 font-mono font-bold" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-800">Nama Kategori</label>
                        <input type="text" name="name" value={category.name} required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">
                            Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        )}
    </div>
</DashboardLayout>

<script define:vars={{ API_URL, id }}>
    const form = document.getElementById('editCategoryForm');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            const formData = new FormData(form);
            const data = { name: formData.get('name') }; // Ambil field name saja

            try {
                const res = await fetch(`${API_URL}/categories/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert("Kategori berhasil diupdate!");
                    window.location.href = '/admin/categories';
                } else {
                    alert("Gagal update");
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                alert("Gagal koneksi server");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    }
</script>