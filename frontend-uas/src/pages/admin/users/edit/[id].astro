---
import DashboardLayout from '../../../../layouts/DashboardLayout.astro';

const { id } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL;

let user = null;
let errorMsg = null;
let formattedDob = '';

try {
    // 1. Ambil Data User Lama
    const res = await fetch(`${API_URL}/users/${id}`);
    if (res.ok) {
        user = await res.json();
        
        // FORMAT TANGGAL: Input type="date" butuh format YYYY-MM-DD
        // Data dari SQL biasanya ISO String (2000-01-01T00:00:00.000Z)
        if (user.dob) {
            const dateObj = new Date(user.dob);
            formattedDob = dateObj.toISOString().split('T')[0];
        }
    } else {
        errorMsg = "User tidak ditemukan.";
    }
} catch (e) {
    errorMsg = "Gagal terhubung ke server.";
}
---

<DashboardLayout title="Edit User" currentPath="users">
    <div class="max-w-2xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Edit Data Kasir</h1>
            <a href="/admin/users" class="text-gray-500 hover:text-blue-600 text-sm">&larr; Kembali</a>
        </div>
        
        {errorMsg && <div class="p-4 bg-red-100 text-red-700 rounded-lg mb-4">{errorMsg}</div>}

        {user && (
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <form id="editUserForm" class="space-y-4">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">ID User</label>
                            {/* ID dibuat Read-Only (Disabled) karena Primary Key */}
                            <input type="text" value={user.id} disabled 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-100 text-gray-500 font-mono" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">Nama Lengkap</label>
                            <input type="text" name="name" value={user.name} required 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">Email</label>
                            <input type="email" name="email" value={user.email} required 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">No. HP</label>
                            <input type="text" name="phone" value={user.phone} required 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">Tempat Lahir</label>
                            <input type="text" name="pob" value={user.pob} required 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">Tanggal Lahir</label>
                            <input type="date" name="dob" value={formattedDob} required 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Jenis Kelamin</label>
                        <select name="gender" required class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-white focus:border-blue-500 focus:outline-none">
                            <option value="">-- Pilih --</option>
                            <option value="L" selected={user.gender === 'L'}>Laki-laki</option>
                            <option value="P" selected={user.gender === 'P'}>Perempuan</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Alamat</label>
                        <textarea name="address" required rows="3"
                                  class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">{user.address}</textarea>
                    </div>

                    <div class="pt-4 flex justify-end gap-3">
                        <a href="/admin/users" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition">Batal</a>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-sm transition">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        )}
    </div>
</DashboardLayout>

<script define:vars={{ API_URL, id }}>
    const form = document.getElementById('editUserForm');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            try {
                // Method PUT untuk Update
                const res = await fetch(`${API_URL}/users/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                
                if(res.ok) {
                    alert("User berhasil diupdate!");
                    window.location.href = '/admin/users';
                } else {
                    alert("Gagal: " + (result.message || "Terjadi kesalahan"));
                }
            } catch(err) { 
                console.error(err);
                alert("Gagal koneksi ke server"); 
            }
        });
    }
</script>