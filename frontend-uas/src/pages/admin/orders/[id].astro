---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
const { id } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL;

let data = null;
let users = []; // List Kasir

try {
    // Fetch Detail Transaksi & List User sekaligus
    const [resTrx, resUsers] = await Promise.all([
        fetch(`${API_URL}/transaksi/${id}`),
        fetch(`${API_URL}/users`)
    ]);

    if (resTrx.ok) data = await resTrx.json();
    if (resUsers.ok) users = await resUsers.json();

} catch (e) {
    console.error("Error loading data", e);
}

const trx = data?.header;
const items = data?.items || [];
---

<DashboardLayout title="Proses Pesanan" currentPath="orders">
    <div class="max-w-4xl mx-auto">
        <div class="mb-6 flex items-center justify-between">
            <h1 class="text-2xl font-bold text-gray-800">Proses Pesanan #{trx?.INVOICE_NO}</h1>
            <a href="/admin/orders" class="text-gray-500 hover:text-blue-600 text-sm flex items-center gap-1">&larr; Kembali</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Item Pesanan</h3>
                <div class="space-y-4">
                    {items.map((item: any) => (
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium text-gray-800">{item.PRODUCT_NAME}</p>
                                <p class="text-xs text-gray-500">{item.QTY} x Rp {parseInt(item.PRICE_AT_PURCHASE).toLocaleString('id-ID')}</p>
                            </div>
                            <p class="font-bold text-gray-700">Rp {parseInt(item.SUBTOTAL).toLocaleString('id-ID')}</p>
                        </div>
                    ))}
                </div>
                <div class="mt-6 pt-4 border-t flex justify-between items-center">
                    <span class="text-gray-500">Total Tagihan</span>
                    <span class="text-2xl font-bold text-blue-600">Rp {parseInt(trx?.TOTAL_AMOUNT).toLocaleString('id-ID')}</span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-fit">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Info Pelanggan</h3>
                <div class="space-y-3 text-sm text-gray-600 mb-6">
                    <p><span class="block text-xs text-gray-400">Nama:</span> {trx?.CUST_NAME || 'Guest'}</p>
                    <p><span class="block text-xs text-gray-400">Alamat:</span> {trx?.CUST_ADDRESS || '-'}</p>
                    <p><span class="block text-xs text-gray-400">Tanggal:</span> {new Date(trx?.ORDER_DATE).toLocaleString('id-ID')}</p>
                    <p><span class="block text-xs text-gray-400">Metode Bayar:</span> <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold">{trx?.METHOD_NAME}</span></p>
                </div>

                <div class="mb-4 pt-4 border-t">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Diproses Oleh (Kasir)</label>
                    <select id="cashierSelect" class="w-full p-2 border rounded-lg text-sm bg-blue-50 border-blue-200 text-blue-800 font-medium focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">-- Pilih Nama Anda --</option>
                        {users.map((u: any) => (
                            // Auto select jika ID user sama dengan user default pesanan (misal ADM001)
                            <option value={u.id} selected={u.id === trx?.USER_ID}>{u.name}</option>
                        ))}
                    </select>
                </div>

                <div class="space-y-3">
                    <button onclick={`processOrder('${id}', 'COMPLETED')`} class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg shadow-green-500/30 transition transform active:scale-95">
                        ✅ Terima & Selesaikan
                    </button>
                    <button onclick={`processOrder('${id}', 'CANCELLED')`} class="w-full bg-red-50 text-red-600 py-3 rounded-lg font-bold hover:bg-red-100 border border-red-200 transition">
                        ❌ Batalkan Pesanan
                    </button>
                </div>
            </div>
        </div>
    </div>
</DashboardLayout>

<script define:vars={{ API_URL }}>
    window.processOrder = async (id, status) => {
        // 1. Validasi Kasir
        const cashierId = document.getElementById('cashierSelect').value;
        if (!cashierId) {
            alert("⚠️ Harap pilih nama Kasir yang memproses pesanan ini!");
            return;
        }

        const action = status === 'COMPLETED' ? 'Menyelesaikan' : 'Membatalkan';
        if (!confirm(`Yakin ingin ${action} pesanan ini?`)) return;

        try {
            // 2. Kirim Request (Status + ID Kasir)
            const res = await fetch(`${API_URL}/transaksi/${id}/status`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    status: status,
                    user_id: cashierId // Kirim ID Kasir baru
                })
            });

            if (res.ok) {
                alert(`Pesanan berhasil di-${status.toLowerCase()} oleh kasir!`);
                window.location.href = '/admin/orders'; 
            } else {
                const json = await res.json();
                alert("Gagal: " + (json.message || "Error"));
            }
        } catch (e) {
            alert("Error koneksi server.");
        }
    }
</script>