---
import DashboardLayout from '../../../../layouts/DashboardLayout.astro';

const { id } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL;

let customer = null;
let errorMsg = null;

try {
    // 1. Ambil Data Customer Berdasarkan ID
    const res = await fetch(`${API_URL}/customers/${id}`);
    if (res.ok) {
        customer = await res.json();
    } else {
        errorMsg = "Data pelanggan tidak ditemukan.";
    }
} catch (e) {
    errorMsg = "Gagal terhubung ke server.";
}
---

<DashboardLayout title="Edit Pelanggan" currentPath="customers">
    <div class="max-w-2xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Edit Data Pelanggan</h1>
            <a href="/admin/customers" class="text-gray-500 hover:text-blue-600 text-sm flex items-center gap-1">
                &larr; Kembali
            </a>
        </div>
        
        {errorMsg && (
            <div class="p-4 bg-red-100 text-red-700 rounded-lg mb-4 border border-red-200">
                {errorMsg}
            </div>
        )}

        {customer && (
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <form id="editCustForm" class="space-y-4">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">ID Pelanggan</label>
                            {/* ID dibuat Read-Only (Disabled) karena Primary Key tidak boleh berubah */}
                            <input type="text" value={customer.id} disabled 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-100 text-gray-500 font-mono" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">Nama Lengkap</label>
                            <input type="text" name="name" value={customer.name} required 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">Email</label>
                            <input type="email" name="email" value={customer.email} required 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 text-gray-700">No. HP</label>
                            <input type="text" name="phone" value={customer.phone} required 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Jenis Kelamin</label>
                        <select name="gender" required class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-white focus:border-blue-500 focus:outline-none">
                            <option value="">-- Pilih --</option>
                            <option value="L" selected={customer.gender === 'L'}>Laki-laki</option>
                            <option value="P" selected={customer.gender === 'P'}>Perempuan</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Alamat</label>
                        <textarea name="address" required rows="3"
                                  class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">{customer.address}</textarea>
                    </div>

                    <div class="pt-4 flex justify-end gap-3">
                        <a href="/admin/customers" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition">Batal</a>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-sm transition">
                            Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        )}
    </div>
</DashboardLayout>

<script define:vars={{ API_URL, id }}>
    const form = document.getElementById('editCustForm');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Ambil data form
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Ubah tombol jadi loading (opsional UI UX)
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            try {
                // Method PUT untuk Update
                const res = await fetch(`${API_URL}/customers/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                
                if(res.ok) {
                    alert("Data pelanggan berhasil diperbarui!");
                    window.location.href = '/admin/customers';
                } else {
                    alert("Gagal: " + (result.message || "Terjadi kesalahan"));
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch(err) { 
                console.error(err);
                alert("Gagal koneksi ke server");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    }
</script>