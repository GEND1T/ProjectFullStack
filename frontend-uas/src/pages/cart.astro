---
import Layout from "../layouts/Layout.astro";

// URL Backend (Server Side)
const API_URL = "http://localhost:3000/api";
---

<Layout title="Keranjang Belanja">
  <div class="max-w-4xl mx-auto px-4 py-10 min-h-[60vh]">
    <h1 class="text-3xl font-bold mb-8 text-gray-800 border-b pb-4">Keranjang Belanja</h1>

    <div id="cart-container" class="space-y-4">
        <p class="text-gray-500 text-center py-10">Memuat keranjang...</p>
    </div>

    <div id="cart-summary" class="hidden mt-8 border-t pt-6 bg-gray-50 p-6 rounded-xl border border-gray-200">
        <div class="flex flex-col md:flex-row justify-between items-start gap-6">
            
            <div class="w-full md:w-1/2">
                <label class="block text-sm font-bold text-gray-700 mb-2">Metode Pembayaran</label>
                <div class="relative">
                    <select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                        <option value="1">Tunai / COD</option>
                        <option value="2">QRIS</option>
                        <option value="3">Transfer Bank</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                
                <div id="user-info-display" class="mt-4 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-100 hidden">
                    </div>
                
                <p class="text-xs text-gray-400 mt-2">
                    *Pesanan akan diproses otomatis oleh sistem.
                </p>
            </div>

            <div class="w-full md:w-1/2 flex flex-col items-end">
                <p class="text-gray-500 text-sm">Total Tagihan</p>
                <p class="text-3xl font-bold text-blue-600 mb-4" id="total-price">Rp 0</p>
                
                <div class="flex gap-3 w-full justify-end">
                    <button onclick="clearCart()" class="px-4 py-3 text-red-500 hover:bg-red-50 rounded-lg font-medium transition border border-red-100">
                        Kosongkan
                    </button>
                    <button id="btn-checkout" onclick="processCheckout()" class="flex-1 md:flex-none px-8 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition transform active:scale-95">
                        Bayar Sekarang
                    </button>
                </div>
            </div>
        </div>
    </div>

  </div>
</Layout>

<script is:inline>
  // --- KONFIGURASI ---
  const API_URL = "http://localhost:3000/api";
  
  // ID Default (Sesuai Database)
  const ONLINE_CASHIER_ID = 'ADM001'; // Admin yang menangani order online
  const GUEST_CUST_ID = 'CUST000';    // ID untuk tamu yang tidak login

  // Helper Format Rupiah
  const toRupiah = (num) => "Rp " + Number(num).toLocaleString('id-ID');

  // --- 1. RENDER KERANJANG ---
  function renderCart() {
    const container = document.getElementById('cart-container');
    const summary = document.getElementById('cart-summary');
    const totalEl = document.getElementById('total-price');
    const userInfoDiv = document.getElementById('user-info-display');

    // Ambil data Cart & User
    let cart = JSON.parse(localStorage.getItem('genexCart')) || [];
    let userStr = localStorage.getItem('genexUser');
    let user = userStr ? JSON.parse(userStr) : null;

    // Tampilkan Info User di Summary
    if (user && user.role === 'customer') {
        userInfoDiv.innerHTML = `üë§ Memesan sebagai: <b>${user.name}</b>`;
        userInfoDiv.classList.remove('hidden');
    } else {
        userInfoDiv.innerHTML = `üë§ Memesan sebagai: <b>Tamu (Guest)</b>`;
        userInfoDiv.classList.remove('hidden');
    }

    // KONDISI 1: Keranjang Kosong
    if (cart.length === 0) {
      container.innerHTML = `
        <div class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-200">
            <span class="material-icons-outlined text-6xl text-gray-300 mb-4">remove_shopping_cart</span>
            <h3 class="text-lg font-medium text-gray-900">Keranjang Kosong</h3>
            <p class="text-gray-500 mb-6">Sepertinya Anda belum memilih produk apapun.</p>
            <a href="/" class="inline-block px-6 py-2 text-white bg-blue-600 rounded-full font-bold hover:bg-blue-700 transition shadow">
                Mulai Belanja
            </a>
        </div>
      `;
      summary.classList.add('hidden');
      return;
    }

    // KONDISI 2: Ada Barang
    let html = '';
    let grandTotal = 0;

    cart.forEach((item, index) => {
      const subtotal = item.price * item.qty;
      grandTotal += subtotal;

      html += `
        <div class="flex flex-col sm:flex-row items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 transition hover:shadow-md">
            <div class="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 border relative">
                <img src="${item.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100?text=No+Img'">
            </div>

            <div class="flex-1 text-center sm:text-left w-full">
                <h3 class="font-bold text-gray-800 line-clamp-1">${item.name}</h3>
                <p class="text-blue-600 text-sm font-medium">${toRupiah(item.price)}</p>
            </div>

            <div class="flex items-center border rounded-lg bg-gray-50">
                <button onclick="updateItem(${index}, -1)" class="px-3 py-1 hover:bg-gray-200 text-gray-600 font-bold disabled:opacity-50">-</button>
                <span class="px-3 py-1 text-sm font-bold bg-white border-x min-w-[40px] text-center">${item.qty}</span>
                <button onclick="updateItem(${index}, 1)" class="px-3 py-1 hover:bg-gray-200 text-gray-600 font-bold">+</button>
            </div>

            <div class="text-right min-w-[120px] w-full sm:w-auto flex justify-between sm:block items-center">
                <span class="sm:hidden text-gray-500 text-sm">Subtotal:</span>
                <div>
                    <p class="font-bold text-gray-800">${toRupiah(subtotal)}</p>
                    <button onclick="removeItem(${index})" class="text-xs text-red-500 hover:text-red-700 font-medium mt-1 flex items-center justify-end gap-1 ml-auto group">
                        <span class="material-icons-outlined text-sm group-hover:scale-110 transition">delete</span> Hapus
                    </button>
                </div>
            </div>
        </div>
      `;
    });

    container.innerHTML = html;
    totalEl.innerText = toRupiah(grandTotal);
    summary.classList.remove('hidden');
  }

  // --- 2. MANAJEMEN ITEM ---
  window.updateItem = (index, delta) => {
    let cart = JSON.parse(localStorage.getItem('genexCart')) || [];
    const item = cart[index];
    const newQty = item.qty + delta;

    if (newQty > 0) {
        // Validasi Stok Maksimal (Dari data yang disimpan saat add to cart)
        if(item.maxStock && newQty > item.maxStock) {
            alert(`Maaf, stok hanya tersedia ${item.maxStock} item.`);
            return;
        }
        cart[index].qty = newQty;
        localStorage.setItem('genexCart', JSON.stringify(cart));
        renderCart();
    } else {
        removeItem(index);
    }
  };

  window.removeItem = (index) => {
    if(!confirm('Hapus produk ini dari keranjang?')) return;
    let cart = JSON.parse(localStorage.getItem('genexCart')) || [];
    cart.splice(index, 1);
    localStorage.setItem('genexCart', JSON.stringify(cart));
    renderCart();
  };

  window.clearCart = () => {
    if(!confirm('Kosongkan seluruh keranjang belanja?')) return;
    localStorage.removeItem('genexCart');
    renderCart();
  }

  // --- 3. PROSES CHECKOUT ---
  window.processCheckout = async () => {
    const btn = document.getElementById('btn-checkout');
    let cart = JSON.parse(localStorage.getItem('genexCart')) || [];

    if(cart.length === 0) return;
    
    // Cek User Login
    const userStr = localStorage.getItem('genexUser');
    const user = userStr ? JSON.parse(userStr) : null;
    
    // Tentukan ID Customer
    // Jika Login Customer -> Pakai ID-nya
    // Jika Tidak Login -> Pakai ID Guest (CUST000)
    const finalCustId = (user && user.role === 'customer') ? user.id : GUEST_CUST_ID;

    if(!confirm(`Lanjutkan pembayaran sebagai ${user ? user.name : 'Tamu'}?`)) return;

    // Siapkan Data
    const methodId = document.getElementById('payment-method').value;
    const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

    const payload = {
        user_id: ONLINE_CASHIER_ID, // Order ini masuk ke sistem Kasir Online
        cust_id: finalCustId,       // ID Customer Asli / Guest
        method_id: parseInt(methodId),
        total_amount: totalAmount,
        items: cart.map(item => ({
            product_id: item.id,
            price: item.price,
            qty: item.qty,
            subtotal: item.price * item.qty
        }))
    };

    // Kirim ke Backend
    try {
        btn.innerText = "Memproses...";
        btn.disabled = true;
        btn.classList.add('opacity-70', 'cursor-not-allowed');

        const response = await fetch(`${API_URL}/transaksi/checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
            // SUKSES
            alert(`‚úÖ Pesanan Berhasil!\n\nNo Invoice: ${result.invoice}\nSilakan tunggu konfirmasi admin.`);
            localStorage.removeItem('genexCart'); // Bersihkan cart
            window.location.reload(); 
        } else {
            // GAGAL
            alert("‚ùå Gagal: " + (result.message || "Terjadi kesalahan server"));
            resetBtn();
        }

    } catch (error) {
        console.error(error);
        alert("‚ö†Ô∏è Error: Gagal terhubung ke server backend.");
        resetBtn();
    }

    function resetBtn() {
        btn.innerText = "Bayar Sekarang";
        btn.disabled = false;
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
    }
  }

  // Jalankan render saat load
  renderCart();
</script>