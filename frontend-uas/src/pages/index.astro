---
import Layout from "../layouts/Layout.astro";
import CategoryCard from "../components/CategoryCard.astro";
import ProductCard from "../components/ProductCard.astro";

// Config API
const API_URL = "http://localhost:3000/api";

let categories = [];
let products = [];
let errorMsg = null;

try {
  const [catRes, prodRes] = await Promise.all([
    fetch(`${API_URL}/products/categories`),
    fetch(`${API_URL}/products`)
  ]);

  categories = await catRes.json();
  const prodData = await prodRes.json();
  products = prodData.data || []; 

} catch (error) {
  console.error("Gagal connect ke backend:", error);
  errorMsg = "Gagal memuat data. Pastikan server backend menyala.";
}
---

<Layout title="Rumah.in - Toko Online Terlengkap">
  <div class="max-w-7xl mx-auto px-4 pt-8 pb-12">

    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-8 md:p-12 text-white mb-12 shadow-lg flex flex-col md:flex-row items-center justify-between">
      <div class="mb-6 md:mb-0">
        <h1 class="text-4xl font-bold mb-4">Belanja Hemat & Lengkap</h1>
        <p class="text-blue-100 text-lg mb-6">Temukan berbagai produk kebutuhan harian dengan harga terbaik.</p>
        <a href="#produk" class="bg-white text-blue-700 px-6 py-3 rounded-full font-bold hover:bg-gray-100 transition shadow-md">
            Mulai Belanja
        </a>
      </div>
      <div class="text-9xl animate-bounce">üõçÔ∏è</div>
    </div>

    {errorMsg && (
        <div class="bg-red-100 text-red-700 p-4 rounded-lg text-center mb-8 border border-red-200">
            {errorMsg}
        </div>
    )}

    <section class="mb-12">
      <div class="flex justify-between items-end mb-6">
        <h2 class="text-2xl font-bold text-gray-800 border-l-4 border-blue-600 pl-3">Kategori</h2>
        <button id="reset-filter" class="text-sm text-blue-600 font-bold hover:underline hidden">
            Tampilkan Semua
        </button>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div class="cursor-pointer category-trigger transition transform hover:-translate-y-1" data-category="all">
            <CategoryCard name="Semua" icon="grid_view" />
        </div>

        {categories.map((cat: any) => (
          // 2. Bungkus CategoryCard dengan div yang bisa diklik dan punya data-category
          <div class="cursor-pointer category-trigger transition transform hover:-translate-y-1" data-category={cat.name}>
             <CategoryCard name={cat.name} icon="category" />
          </div>
        ))}
      </div>
    </section>

    <section id="produk">
      <div class="flex items-center gap-2 mb-6">
          <h2 class="text-2xl font-bold text-gray-800 border-l-4 border-blue-600 pl-3">Produk Terbaru</h2>
          <span id="active-category-label" class="text-gray-500 text-sm font-medium bg-gray-100 px-3 py-1 rounded-full hidden"></span>
      </div>

      {products.length > 0 ? (
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" id="product-grid">
          {products.map((p: any) => (
            // 3. PENTING: Bungkus ProductCard dengan div yang menyimpan nama kategori
            // Pastikan backend mengirim field 'category_name' atau sesuaikan dengan nama kolom kategori di database Anda
            <div class="product-item transition-all duration-300" data-category={p.category_name || p.Category?.name || "Uncategorized"}>
                <ProductCard 
                id={p.id}
                name={p.name} 
                price={p.price} 
                image={p.image}
                />
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-20 text-gray-500 bg-white rounded-xl border border-dashed">
          <p>Belum ada produk yang tersedia.</p>
        </div>
      )}
      
      <div id="empty-message" class="hidden text-center py-20 text-gray-500 bg-white rounded-xl border border-dashed">
          <p>Tidak ada produk di kategori ini.</p>
      </div>
    </section>

  </div>
</Layout>
<script>
  // 1. Casting Element saat pengambilan awal agar TypeScript tahu tipenya
  const categoryButtons = document.querySelectorAll('.category-trigger');
  const productItems = document.querySelectorAll('.product-item');
  const emptyMessage = document.getElementById('empty-message') as HTMLElement | null;
  const resetBtn = document.getElementById('reset-filter') as HTMLElement | null;
  const activeLabel = document.getElementById('active-category-label') as HTMLElement | null;

  // 2. Berikan tipe data ': string' pada parameter
  function filterProducts(categoryName: string) {
      let visibleCount = 0;

      // 3. Cek Null (Guard Clause) untuk activeLabel & resetBtn
      if (activeLabel && resetBtn) {
          if (categoryName === 'all') {
              activeLabel.classList.add('hidden');
              resetBtn.classList.add('hidden');
          } else {
              activeLabel.textContent = `Kategori: ${categoryName}`;
              activeLabel.classList.remove('hidden');
              resetBtn.classList.remove('hidden');
          }
      }

      // Loop semua produk
      productItems.forEach((element) => {
          // 4. Casting ke HTMLElement agar properti '.style' dikenali
          const item = element as HTMLElement;

          // 5. Handle kemungkinan null pada getAttribute dengan '|| ""'
          const productCat = item.getAttribute('data-category') || "";
          
          // Logic Cek
          if (categoryName === 'all' || productCat.toLowerCase() === categoryName.toLowerCase()) {
              item.style.display = 'block'; 
              
              // Animasi kecil saat muncul
              item.style.opacity = '0';
              setTimeout(() => item.style.opacity = '1', 50);
              visibleCount++;
          } else {
              item.style.display = 'none'; 
          }
      });

      // 6. Cek Null untuk emptyMessage
      if (emptyMessage) {
          if (visibleCount === 0) {
              emptyMessage.classList.remove('hidden');
          } else {
              emptyMessage.classList.add('hidden');
          }
      }
  }

  // Event Listener untuk setiap tombol kategori
  categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
          const selectedCat = btn.getAttribute('data-category') || 'all'; // Default 'all' jika null
          filterProducts(selectedCat);
          
          const produkSection = document.getElementById('produk');
          if(produkSection) {
              produkSection.scrollIntoView({ behavior: 'smooth' });
          }
      });
  });

  // Event Listener tombol reset (Cek null dulu)
  if(resetBtn) {
      resetBtn.addEventListener('click', () => {
          filterProducts('all');
      });
  }
</script>